"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var _cache2={},hooks={},persist=!0;try{localStorage.setItem("tdmnco-model-js",{}),localStorage.removeItem("tdmnco-model-js")}catch(e){console.warn("Model.js: localStorage not supported!",e),persist=!1}var Model=function(){function t(e){if(_classCallCheck(this,t),!e.id)throw new Error("Model.js: cannot create instance without an id!");Object.assign(this,e);var c=this.constructor.prototype.modelName||this.constructor.name,s=this.id;return _cache2[c]||(_cache2[c]={}),hooks[c]||(hooks[c]={}),hooks[c][s]={onbeforedelete:[],onbeforeupdate:[]},new Proxy(this,{get:function(e,t,o){return Reflect.get(e,t,o)},set:function(e,t,o){var r=!0,n=!1,a=void 0;try{for(var i,l=hooks[c][s].onbeforeupdate[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){(0,i.value)(t,e[t],o)}}catch(e){n=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(n)throw a}}return Reflect.set(e,t,o),!0}})}return _createClass(t,[{key:"_cache",value:function(){var e=(new Date).toISOString(),t=this._cached();return t?(t.instance=this,t.updated=e):(t={created:e,instance:this},_cache2[this._modelName()][this.id]=t),t}},{key:"_cached",value:function(){return _cache2[this._modelName()][this.id]}},{key:"_hook",value:function(e,t){hooks[this._modelName()][this.id][e].push(t)}},{key:"_id",value:function(){return this._modelName()+"-"+this.id}},{key:"_modelName",value:function(){return this.constructor.prototype.modelName||this.constructor.name}},{key:"delete",value:function(){var e=this.id,t=this._modelName(),o=hooks[t][e].onbeforedelete;if(o.length){var r=!0,n=!1,a=void 0;try{for(var i,l=o[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){(0,i.value)()}}catch(e){n=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(n)throw a}}}delete _cache2[t][e],delete hooks[t][e],persist&&localStorage.removeItem(this._id())}},{key:"onbeforedelete",value:function(e){this._hook("onbeforedelete",e)}},{key:"onbeforeupdate",value:function(e){this._hook("onbeforeupdate",e)}},{key:"save",value:function(){this._cache(),persist&&localStorage.setItem(this._id(),JSON.stringify(this))}}],[{key:"cache",value:function(){return _cache2[this._modelName()]}},{key:"deleteCache",value:function(){_cache2[this._modelName()]={}}},{key:"first",value:function(e){return this.get(e)[0]}},{key:"get",value:function(e){var t=_typeof(e);return"undefined"===t?this._getInstances():/string|number/.test(t)?this._getById(e):e instanceof Array&&0<e.length?this._getByIds(e):e instanceof Object?this._getByProperties(e):null}},{key:"load",value:function(s){var u=this;return new Promise(function(e){var t=s&&s.length;if(t){var o=0,r=!0,n=!1,a=void 0;try{for(var i,l=s[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){var c=i.value;new u(c).save(),++o===t&&e(o)}}catch(e){n=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(n)throw a}}}else e()})}},{key:"preload",value:function(i){var l=this,c=this._modelName(),s=c.length;return new Promise(function(e,t){if(!i||i.localStorage)for(var o=localStorage.length,r=0,n=0;n<o;n++){var a=localStorage.key(n);a.slice(0,s)===c&&new l(JSON.parse(localStorage.getItem(a)))._cache(),++r===o&&e(r)}else t(new Error("Model.js: no options given to "+c+".load()!"))})}},{key:"_getById",value:function(e){var t=this._modelName(),o=_cache2[t]&&_cache2[t][e];if(o)return o.instance;if(persist){var r=JSON.parse(localStorage.getItem(t+"-"+e));if(r&&r.id)return new this(r)}return null}},{key:"_getByIds",value:function(e){var t=[],o=this._modelName();for(var r in _cache2[o]){var n=_cache2[o][r].instance,a=!0,i=!1,l=void 0;try{for(var c,s=e[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var u=c.value;if(n.id===u){t.push(n);break}}}catch(e){i=!0,l=e}finally{try{a||null==s.return||s.return()}finally{if(i)throw l}}}return t}},{key:"_getByProperties",value:function(e){var t=[],o=_cache2[this._modelName()];for(var r in o){var n=o[r].instance,a=!0;for(var i in e)if(n[i]!==e[i]){a=!1;break}a&&t.push(n)}return t}},{key:"_getInstances",value:function(){var e=[],t=_cache2[this._modelName()];for(var o in t)e.push(t[o].instance);return e}},{key:"_modelName",value:function(){return this.prototype.modelName||this.prototype.constructor.name}}]),t}();module.exports=Model;