{"version":3,"sources":["model.js","index.js"],"names":["cache","hooks","persist","localStorage","setItem","removeItem","error","console","warn","Model","data","id","Error","Object","assign","modelName","constructor","prototype","name","onbeforedelete","onbeforeupdate","Proxy","get","target","property","receiver","Reflect","set","value","frozen","onbeforeupdates","length","callback","cached","_cached","now","Date","toISOString","instance","updated","created","_modelName","type","push","onbeforedeletes","_id","_hook","_cache","JSON","stringify","query","_getById","Array","_getByIds","_getByProperties","_getInstances","options","count","i","key","slice","parse","getItem","stored","matches","modelCache","match"],"mappings":"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","file":"index.map","sourceRoot":"../src/js","sourcesContent":["// Variables:\nlet cache = {}\nlet hooks = {}\nlet persist = true\n\n// Test for localStorage support:\ntry {\n  localStorage.setItem('tdmnco-model-js', {})\n  localStorage.removeItem('tdmnco-model-js')\n} catch(error) {\n  console.warn('Model.js: localStorage not supported!', error)\n\n  persist = false\n}\n\n// Classes:\nclass Model {\n  constructor(data) {\n    if (!data.id) {\n      throw new Error('Model.js: cannot create instance without an id!')\n    }\n\n    Object.assign(this, data)\n\n    const modelName = this.constructor.prototype.modelName || this.constructor.name\n    const id = this.id\n\n    if (!cache[modelName]) {\n      cache[modelName] = {}\n    }\n\n    if (!hooks[modelName]) {\n      hooks[modelName] = {}\n    }\n\n    hooks[modelName][id] = {\n      onbeforedelete: [],\n      onbeforeupdate: []\n    }\n\n    return new Proxy(this, {\n      get(target, property, receiver) {\n\t\t\t\treturn Reflect.get(target, property, receiver);\n      },\n\n      set(target, property, value) {\n        if (!target.frozen()) {\n          let onbeforeupdates = hooks[modelName][id].onbeforeupdate\n\n          if (onbeforeupdates.length) {\n            for (let callback of onbeforeupdates) {\n              callback(property, target[property], value)\n            }\n          }\n\n          Reflect.set(target, property, value)\n        }\n\n        return true\n      }\n    })\n  }\n\n  // Static functions:\n  static cache() {\n    return cache[this._modelName()]\n  }\n\n  static deleteCache() {\n    cache[this._modelName()] = {}\n  }\n\n  static first(query) {\n    return this.get(query)[0]\n  }\n\n  static get(query) {\n    if (!query) {\n      return this._getInstances()\n    }\n\n    if (typeof query === 'string') {\n      return this._getById(query)\n    }\n\n    if (query instanceof Array) {\n      return this._getByIds(query)\n    }\n\n    if (query instanceof Object) {\n      return this._getByProperties(query)\n    }\n  }\n\n  static preload(options) {\n    const modelName = this._modelName()\n    const length = modelName.length\n\n    if (!options || options.localStorage) {\n      const count = localStorage.length\n\n      for (let i = 0; i < count; i++) {\n        let key = localStorage.key(i)\n\n        if (key.slice(0, length) === modelName) {\n          new this(JSON.parse(localStorage.getItem(key)))._cache()\n        }\n      }\n    }\n  }\n\n  // Private static functions:\n  static _getById(query) {\n    const modelName = this._modelName()\n    const cached = cache[modelName][query]\n\n    if (cached) {\n      return cached.instance\n    }\n\n    if (persist) {\n      const stored = JSON.parse(localStorage.getItem(modelName + '-' + query))\n\n      if (stored && stored.id) {\n        return new this(stored)\n      }\n    }\n\n    return null\n  }\n\n  static _getByIds(query) {\n    const modelName = this._modelName()\n\n    let matches = []\n\n    for (let id in cache[modelName]) {\n      const instance = cache[modelName][id].instance\n\n      for (let id of query) {\n        if (instance.id === id) {\n          matches.push(instance)\n\n          break\n        }\n      }\n    }\n\n    return matches\n  }\n\n  static _getByProperties(query) {\n    const modelCache = cache[this._modelName()]\n\n    let matches = []\n\n    for (let id in modelCache) {\n      const instance = modelCache[id].instance\n      \n      let match = true\n\n      for (let property in query) {\n        if (instance[property] !== query[property]) {\n          match = false\n\n          break\n        }\n      }\n\n      if (match) {\n        matches.push(instance)\n      }\n    }\n\n    return matches\n  }\n\n  static _getInstances() {\n    const modelCache = cache[this._modelName()]\n\n    let matches = []\n    \n    for (let id in modelCache) {\n      matches.push(modelCache[id].instance)\n    }\n\n    return matches\n  }\n\n  static _modelName() {\n    return this.prototype.modelName || this.prototype.constructor.name\n  }\n\n  // Private functions:\n  _cache() {\n    let cached = this._cached()\n    let now = new Date().toISOString()\n\n    if (!cached) {\n      cached = { created: now, frozen: false, instance: this }\n\n      cache[this._modelName()][this.id] = cached\n    } else {\n      cached.instance = this\n      cached.updated = now\n    }\n\n    return cached\n  }\n\n  _cached() {\n    return cache[this._modelName()][this.id]\n  }\n\n  _hook(type, callback) {\n    hooks[this._modelName()][this.id][type].push(callback)\n  }\n\n  _id() {\n    return this._modelName() + '-' + this.id\n  }\n\n  _modelName() {\n    return this.constructor.prototype.modelName || this.constructor.name\n  }\n\n  // Public functions:\n  delete() {\n    const id = this.id\n    const modelName = this._modelName()\n\n    let onbeforedeletes = hooks[modelName][id].onbeforedelete\n\n    if (onbeforedeletes.length) {\n      for (let callback of onbeforedeletes) {\n        callback()\n      }\n    }\n\n    delete cache[modelName][id]\n    delete hooks[modelName][id]\n\n    if (persist) {\n      localStorage.removeItem(this._id())\n    }\n  }\n\n  freeze() {\n    this._cached().frozen = true\n  }\n\n  frozen() {\n    if (!this._cached()) {\n      return false\n    }\n\n    return this._cached().frozen\n  }\n\n  onbeforedelete(callback) {\n    this._hook('onbeforedelete', callback)\n  }\n\n  onbeforeupdate(callback) {\n    this._hook('onbeforeupdate', callback)\n  }\n\n  save() {\n    this._cache()\n\n    if (persist) {\n      localStorage.setItem(this._id(), JSON.stringify(this))\n    }\n  }\n\n  thaw() {\n    this._cached().frozen = false\n  }\n}\n\n// Exports:\nexport { Model }\n","// Exports:\nexport { Model } from './model'\n"]}